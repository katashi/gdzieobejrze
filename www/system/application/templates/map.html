{include file="extension/header_map.html"}

<div class="wrapper" style="height:100%">
    <!-- header -->
    <!-- top menu -->
    <div id="header-podstrona">

        <ul style="padding-right:8px;" class="sf-menu">
            {include file="extension/map_menu_top.html"}
        </ul>
    </div>
    <!-- end top menu-->
    <!-- left menu-->
    {include file="extension/map_menu_left.html"}
    <!-- end left menu -->
    <!-- slider right-->
    {include file="extension/map_slider_right.html"}
    <!-- end slider right-->

    <!-- map engine here -->
    {literal}
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOT0jFTVnhxf2GhgSsnfSY8L251FRRC6w&sensor=false&region=PL"></script>
    <script type="text/javascript">

        // some declarations
        var obj;
        var map;
        var markers;
        var navMode;
        var travelMode = google.maps.DirectionsTravelMode.DRIVING;
        var liveOriginLat;
        var liveOriginLng;
        var fixedOriginLat;
        var fixedOriginLng;
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();

        // we need to be ready!
        obj = $(document).ready(function() {

            // we want some data from backoffice
            $.ajax({
                url: "http://www.knsdes.nazwa.pl/www_gdzieobejrze_pl/console/index.php/main/run/gdzieobejrze:partner/load_all",
                dataType: 'json',
                context: document.body
            }).done(function(output) {
               init(output.data)
            });

        });

        function init(data) {
            markers = data;
            initMap();
            initMarkers();
            initRoute();
        }
        function initMap() {
            var mapOptions = {
                center: new google.maps.LatLng(52.22772220173582,21.000972390174866),
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zoom: 14
            }
            map = new google.maps.Map(document.getElementById('mapa'), mapOptions);
        }
        function initMarkers() {
            for(x in markers) {
                data = markers[x]
                pos = data.gm_position.split(',')
                if (data.gm_icon_url != '') {
                    var marker = new google.maps.Marker({
                        map: map,
                        icon: new google.maps.MarkerImage(
                                data.gm_icon_url
                        ),
                        position: new google.maps.LatLng(pos[0], pos[1]),
                        title: data.title
                    });
                }

            }
        }
        function initRoute() {
            if (navigator.geolocation) {
                var ng = navigator.geolocation.getCurrentPosition(function (position) {
                    livePositionLat = position.coords.latitude;
                    livePositionLng = position.coords.longitude;
                    navMode = 'live';
                    calculateRoute();
                });
            } else {
                fixedOriginLat = 52.16729892540329;
                fixedOriginLng = 20.80587387084961;
                navMode = 'fixed';
                calculateRoute();
            }
        }

        function calculateRoute() {
            if (navMode == 'live') {
                var lat = livePositionLat;
                var lng = livePositionLng;
            }
            if (navMode == 'fixed') {
                var lat = fixedPositionLat;
                var lng = fixedPositionLng;
            }
            //
            var testTarget = markers[0]['gm_position'].split(',');
            //
            var travel = {
                origin: new google.maps.LatLng(lat, lng),
                destination: new google.maps.LatLng(testTarget[0], testTarget[1]),
                travelMode: travelMode
            }
            var options = {
                suppressMarkers: true
            }
            directionsRenderer.setMap(map);
            directionsRenderer.setOptions(options);

            directionsService.route(travel, function (result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                }
            });
        }
        function setTravelMode(mode) {
            if (mode == 'WALKING') {
                travelMode = google.maps.DirectionsTravelMode.WALKING;
            }
            if (mode == 'DRIVING') {
                travelMode = google.maps.DirectionsTravelMode.DRIVING;
            }
            directionsRenderer.setMap(null);
            calculateRoute();
        }

    </script>
    {/literal}
    <div id="mapa" style="position:fixed!important;"></div>

    <div id="popupwindow" style="display:none;position: absolute!important;"></div>

    <div id="popupwindow2" style="display:none;position: absolute!important;"></div>
</div>
    <!--{include file="extension/map_footer.html"}-->